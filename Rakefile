task default: [:uninstall, :install]

@BASHRC = <<END
#!/bin/sh
#
# NOTE: Do **NOT** edit this file.
#   This file is automated generated by cybertk/profile.
#   Edit profile/bashrc instead.

CK_BASHRC_DIR="#{File.dirname(__FILE__)}"
# Source bashrc provided by cybertk/profile
. ${CK_BASHRC_DIR}/bashrc
END

def backup(file)
    if not File.exist?(file)
        return
    end

    backup_file = file
    while File.exist?(backup_file)
        backup_file += ".bak"
    end

    File.rename(file, backup_file)
    puts "Backup #{file} to #{backup_file}"
end

def install_bashrc(file)
    puts "Instaling #{file}"

    file = File.expand_path file

    backup(file)
    File.open(file, 'w') do |f|
        f.write(@BASHRC)
    end
end

def uninstall_bashrc(file)
    file = File.expand_path file
    c = File.read(file)
    if c == @BASHRC
        backup_file = "#{file}.bak"
        if File.exist?(backup_file)
            puts "Restoring #{backup_file}"
            File.delete(file)
            File.rename(backup_file, file)
        end
    end
end

task :install do
    install_bashrc('~/.bashrc')
    install_bashrc('~/.bash_profile')
    install_link('.vim')
    install_link('.vimrc')
end

task :uninstall do
    uninstall_bashrc('~/.bashrc')
    uninstall_bashrc('~/.bash_profile')
end

task :lint do
    shs = Dir.glob("**/*.sh")
    shs << "bashrc"

    sh "shellcheck #{shs.join(' ')}"
end
